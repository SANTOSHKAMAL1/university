<!-- templates/drive_files.html -->
{% extends "base_user.html" %}
{% block title %}Google Drive - Jain University{% endblock %}
{% block page_title %}ðŸ“‚ My Google Drive Folders{% endblock %}

{% block content %}
<div class="p-8">
    <div class="max-w-7xl mx-auto">
        
        <!-- Search and Filter Bar -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <div class="flex flex-col md:flex-row gap-4">
                <!-- Search Box -->
                <div class="flex-1">
                    <div class="relative">
                        <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                        <input type="text" id="folderSearch" 
                               placeholder="Search folders by name..." 
                               class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                
                <!-- Sort Dropdown -->
                <div class="w-full md:w-48">
                    <select id="sortFolders" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
                        <option value="name_asc">Name (A-Z)</option>
                        <option value="name_desc">Name (Z-A)</option>
                        <option value="date_new">Newest First</option>
                        <option value="date_old">Oldest First</option>
                    </select>
                </div>
                
                <!-- Add All Saved Button -->
                {% if saved_folder_ids and saved_folder_ids|length > 0 %}
                <form method="POST" action="{{ url_for('add_all_folders_to_navbar') }}" 
                      onsubmit="return confirm('Add all unsaved folders to your navigation?');">
                    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded-lg transition duration-200 flex items-center gap-2 whitespace-nowrap">
                        <i class="fas fa-plus-circle"></i>
                        <span>Add All Unsaved</span>
                    </button>
                </form>
                {% endif %}
            </div>
        </div>

        {% if folders and folders|length > 0 %}
            <!-- Folder Cards Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8" id="foldersGrid">
                {% for folder in folders %}
                    <div class="folder-card bg-white rounded-lg shadow-md hover:shadow-xl transition-all duration-300 overflow-hidden" 
                         data-name="{{ folder.name.lower() }}"
                         data-date="{{ folder.createdTime if folder.createdTime else '' }}">
                        
                        <!-- Folder Header with Dropdown -->
                        <div class="bg-gradient-to-r from-yellow-400 to-orange-500 p-5 text-white">
                            <div class="flex items-start justify-between">
                                <div class="flex items-start gap-3 flex-1 min-w-0">
                                    <i class="fas fa-folder text-3xl flex-shrink-0 mt-1"></i>
                                    <div class="flex-1 min-w-0">
                                        <h3 class="font-bold text-lg break-words leading-tight mb-2 folder-name">
                                            {{ folder.name }}
                                        </h3>
                                        <p class="text-xs opacity-90">
                                            <i class="far fa-calendar-alt mr-1"></i>
                                            {% if folder.createdTime %}
                                                {{ folder.createdTime[:10] }}
                                            {% else %}
                                                N/A
                                            {% endif %}
                                        </p>
                                    </div>
                                </div>
                                
                                <!-- Quick Actions Dropdown -->
                                <div class="relative">
                                    <button class="folder-actions-btn text-white hover:bg-yellow-500 rounded-full p-2 transition">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <div class="folder-actions-menu absolute right-0 top-full mt-1 bg-white rounded-lg shadow-xl border border-gray-200 py-2 z-10 hidden w-48">
                                        {% if folder.id in saved_folder_ids %}
                                            <form method="POST" action="{{ url_for('remove_folder_from_navbar', folder_id=folder.id) }}" 
                                                  onsubmit="return confirm('Remove this folder from navigation?');">
                                                <button type="submit" class="w-full text-left px-4 py-2 text-red-600 hover:bg-red-50 flex items-center gap-2">
                                                    <i class="fas fa-trash-alt"></i>
                                                    Remove from Navbar
                                                </button>
                                            </form>
                                        {% else %}
                                            <form method="POST" action="{{ url_for('add_folder_to_navbar') }}">
                                                <input type="hidden" name="folder_id" value="{{ folder.id }}">
                                                <input type="hidden" name="folder_name" value="{{ folder.name }}">
                                                <button type="submit" class="w-full text-left px-4 py-2 text-green-600 hover:bg-green-50 flex items-center gap-2">
                                                    <i class="fas fa-plus-circle"></i>
                                                    Add to Navbar
                                                </button>
                                            </form>
                                        {% endif %}
                                        <a href="{{ folder.webViewLink if folder.webViewLink else 'https://drive.google.com/drive/folders/' + folder.id }}" 
                                           target="_blank" 
                                           class="block px-4 py-2 text-blue-600 hover:bg-blue-50 flex items-center gap-2">
                                            <i class="fas fa-external-link-alt"></i>
                                            Open in Drive
                                        </a>
                                        <button onclick="copyToClipboard('{{ folder.id }}')" 
                                                class="w-full text-left px-4 py-2 text-gray-700 hover:bg-gray-100 flex items-center gap-2">
                                            <i class="fas fa-copy"></i>
                                            Copy Folder ID
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Status and Actions -->
                        <div class="p-4">
                            {% if folder.id in saved_folder_ids %}
                                <div class="mb-3 bg-green-50 border border-green-200 rounded-lg p-3">
                                    <span class="text-green-700 text-sm font-semibold flex items-center gap-2">
                                        <i class="fas fa-check-circle"></i>
                                        Added to Navigation
                                    </span>
                                </div>
                            {% endif %}
                            
                            <!-- Quick Add Button -->
                            {% if folder.id not in saved_folder_ids %}
                            <form method="POST" action="{{ url_for('add_folder_to_navbar') }}" class="mb-3">
                                <input type="hidden" name="folder_id" value="{{ folder.id }}">
                                <input type="hidden" name="folder_name" value="{{ folder.name }}">
                                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition flex items-center justify-center gap-2">
                                    <i class="fas fa-plus"></i>
                                    Quick Add to Navbar
                                </button>
                            </form>
                            {% endif %}
                            
                            <!-- Folder ID -->
                            <div class="text-xs text-gray-500 flex items-center gap-2">
                                <i class="fas fa-fingerprint"></i>
                                <span class="truncate font-mono" title="{{ folder.id }}">{{ folder.id|truncate(20) }}</span>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
            
            <!-- No Results Message -->
            <div id="noResults" class="hidden text-center py-8">
                <i class="fas fa-search text-gray-300 text-4xl mb-4"></i>
                <h3 class="text-xl font-bold text-gray-600">No folders found</h3>
                <p class="text-gray-500">Try adjusting your search terms</p>
            </div>
            
        {% else %}
            <!-- Empty State (same as before) -->
            <div class="bg-white rounded-lg shadow-md p-12 text-center">
                <!-- ... existing empty state code ... -->
            </div>
        {% endif %}

    </div>
</div>

<script>
// Search functionality
document.getElementById('folderSearch').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase().trim();
    const folders = document.querySelectorAll('.folder-card');
    let visibleCount = 0;
    
    folders.forEach(folder => {
        const folderName = folder.querySelector('.folder-name').textContent.toLowerCase();
        if (folderName.includes(searchTerm) || searchTerm === '') {
            folder.style.display = 'block';
            visibleCount++;
        } else {
            folder.style.display = 'none';
        }
    });
    
    // Show/hide no results message
    const noResults = document.getElementById('noResults');
    if (visibleCount === 0 && searchTerm !== '') {
        noResults.classList.remove('hidden');
    } else {
        noResults.classList.add('hidden');
    }
});

// Sort functionality
document.getElementById('sortFolders').addEventListener('change', function() {
    const sortValue = this.value;
    const grid = document.getElementById('foldersGrid');
    const folders = Array.from(grid.querySelectorAll('.folder-card'));
    
    folders.sort((a, b) => {
        const nameA = a.querySelector('.folder-name').textContent.toLowerCase();
        const nameB = b.querySelector('.folder-name').textContent.toLowerCase();
        const dateA = a.getAttribute('data-date');
        const dateB = b.getAttribute('data-date');
        
        switch(sortValue) {
            case 'name_asc':
                return nameA.localeCompare(nameB);
            case 'name_desc':
                return nameB.localeCompare(nameA);
            case 'date_new':
                return new Date(dateB) - new Date(dateA);
            case 'date_old':
                return new Date(dateA) - new Date(dateB);
            default:
                return 0;
        }
    });
    
    // Reorder in DOM
    folders.forEach(folder => grid.appendChild(folder));
});

// Dropdown menu toggle
document.addEventListener('click', function(e) {
    if (e.target.closest('.folder-actions-btn')) {
        const btn = e.target.closest('.folder-actions-btn');
        const menu = btn.nextElementSibling;
        menu.classList.toggle('hidden');
    } else {
        // Close all open menus
        document.querySelectorAll('.folder-actions-menu').forEach(menu => {
            menu.classList.add('hidden');
        });
    }
});

// Copy to clipboard function
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        const toast = document.createElement('div');
        toast.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 animate-fade-in';
        toast.textContent = 'Copied to clipboard!';
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 2000);
    });
}
</script>

<style>
.animate-fade-in {
    animation: fadeIn 0.3s ease-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

.folder-actions-menu {
    animation: slideDown 0.2s ease-out;
}

@keyframes slideDown {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}
</style>
{% endblock %}